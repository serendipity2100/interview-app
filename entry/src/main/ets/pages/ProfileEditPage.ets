import { iLoginUserModel } from '../models/AccountModel'
import { fileIo, picker } from '@kit.CoreFileKit'
import { emitter, request } from '@kit.BasicServicesKit'
import { request as axiosRequest } from '../common/utils/request'

import { http } from '@kit.NetworkKit'
import { promptAction } from '@kit.ArkUI'
import { HdLoadingDialog } from '../common/components/HdLoading'


@Entry
@Component
struct ProfileEditPage {
  // è·å–ç™»å½•ç”¨æˆ·æ•°æ®
  @StorageProp('user') currentUser: iLoginUserModel = {} as iLoginUserModel
  // è·å–å®‰å…¨åŒºåŸŸé«˜åº¦æ•°æ®
  @StorageProp("topHeight") topHeight: number = 0
  // éœ€æ±‚: ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶æç¤ºä¸Šä¼ è¿›åº¦

  // 4. å®šä¹‰ä¸€ä¸ªpercentçŠ¶æ€å˜é‡
  @State percent: string = '0%'
  // 1. åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å¼¹çª—ç»„ä»¶æ§åˆ¶å™¨
  dialog = new CustomDialogController({
    // 5. ä½¿ç”¨çŠ¶æ€å˜é‡, ä¼ ç»™è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶.   âŒâŒâŒâŒ @Stateè¿™äº›è£…é¥°å™¨, åªèƒ½æ›´æ–°buildå‡½æ•°ä¸­æ‘†å‡ºæ¥çš„ç»„ä»¶, æ— æ³•æ›´æ–°CustomDialogä¸­çš„ç»„ä»¶å†…å®¹
    builder: HdLoadingDialog({ message: 'ä¸Šä¼ è¿›åº¦ä¸º' + this.percent }),
    customStyle: true
  })

  build() {
    Navigation() {
      Stack() {
        List() {
          ListItem() {
            Row() {
              Text('å¤´åƒ')
              // å›æ˜¾ç”¨æˆ·å¤´åƒ
              Image(this.currentUser.avatar)
                .width((40))
                .width((40))
                .borderRadius((40))
                .border({ width: 0.5, color: '#e4e4e4' })
                .onClick(async () => {
                  const xxxPicker = new picker.PhotoViewPicker()
                  const res = await xxxPicker.select({
                    MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
                    maxSelectNumber: 1
                  })

                  if (res.photoUris.length === 0) {
                    return
                  }

                  const context = getContext(this)
                  const cacheDir = context.cacheDir

                  const oldPath = res.photoUris[0]
                  const oldFile = fileIo.openSync(oldPath, fileIo.OpenMode.READ_ONLY)

                  const fileName = Date.now()
                  fileIo.copyFileSync(oldFile.fd, cacheDir + '/' + `${fileName}.jpg`)


                  // 2.ä¸Šä¼ å‰æ‰“å¼€è‡ªå®šä¹‰å¼¹çª—
                  this.dialog.open()
                  const task = await request.uploadFile(context, {
                    url: 'https://api-harmony-teach.itheima.net/hm/userInfo/avatar',
                    header: {
                      'content-type': 'multipart/form-data',
                      Authorization: `Bearer ${this.currentUser.token}`
                    },
                    method: http.RequestMethod.POST,
                    files: [{
                      filename: `${fileName}.jpg`,
                      uri: `internal://cache/${fileName}.jpg`,
                      name: 'file',
                      type: 'jpg'
                    }],
                    data: []
                  })


                  task.on('fail', (err) => {
                    AlertDialog.show({ message: JSON.stringify(err, null, 2), alignment: DialogAlignment.Center })
                  })

                  task.on('progress', async (updatedSize, totalSize) => {

                    const percent = (updatedSize / totalSize * 100).toFixed(2) + '%'

                    // ğŸ’¥è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶æ— æ³•é€šè¿‡çˆ¶ä¼ å­æ›´æ–°æ•°æ®
                    // 1. ä½¿ç”¨emitter.emit('äº‹ä»¶å',  {data: {é”®: å€¼}})
                    emitter.emit('updateMsg', {
                      data: {
                        xxx: `ä¸Šä¼ è¿›åº¦ä¸º${percent}`
                      }
                    })


                    if (updatedSize === totalSize) {
                      // 3. ä¸Šä¼ æˆåŠŸåå…³é—­
                      this.dialog.close()
                      const res = await axiosRequest<iLoginUserModel>({ url: 'hm/userInfo' })
                      this.currentUser.avatar = res.data.data.avatar
                    }

                  })

                })
            }.width('100%').height((60)).justifyContent(FlexAlign.SpaceBetween)
          }

          ListItem() {
            Row() {
              Text('æ˜µç§°')
              // å›æ˜¾ç”¨æˆ·æ˜µç§°
              TextInput({ text: this.currentUser.nickName || 'æ˜µç§°' })
                .textAlign(TextAlign.End)
                .layoutWeight(1)
                .padding(0)
                .height((60))
                .backgroundColor(Color.Transparent)
                .borderRadius(0)
                .onSubmit(() => {
                  // ä¿®æ”¹æ˜µç§° this.updateNickName()

                })
            }.width('100%').height(60).justifyContent(FlexAlign.SpaceBetween)
          }
        }
        .width('100%')
        .height('100%')
        .padding({
          left: (45),
          right: (45),
          top: (15),
          bottom: (15)
        })
        .divider({ strokeWidth: 0.5, color: '#f5f5f5' })

      }.width('100%')
      .height('100%')
    }
    .padding({ top: this.topHeight + 10 })
    .title('å®Œå–„ä¸ªäººä¿¡æ¯')
    .titleMode(NavigationTitleMode.Mini)
    .mode(NavigationMode.Stack)
    .linearGradient({
      colors: [['#FFB071', 0], ['#f3f4f5', 0.3], ['#f3f4f5', 1]]
    })
  }
}