import axios, { AxiosError, AxiosRequestConfig, AxiosResponse, InternalAxiosRequestConfig } from '@ohos/axios'
import { iLoginUserModel } from '../../models/AccountModel';
import { promptAction } from '@kit.ArkUI';

export const instance = axios.create({
  baseURL: 'https://api-harmony-teach.itheima.net/'
})


export function request<T = null, D = null>(config: AxiosRequestConfig<D>) {
  return instance<null, AxiosResponse<T, null>, D>(config)
}


// Êã¶Êà™Âô®:
// Êú¨Ë¥®: Èí©Â≠êÂáΩÊï∞ - Ëá™Âä®ÊâßË°å
// Êó∂Êú∫: ËØ∑Ê±ÇÊã¶Êà™Âô® - ËØ∑Ê±ÇÂâçÊâßË°å
// Êó∂Êú∫: ÂìçÂ∫îÊã¶Êà™Âô® - ÂìçÂ∫îÊó∂ÊâßË°å

// 1. Êã¶Êà™Âô®ÈÖçÁΩÆÂú®ÂÆû‰æãÂØπË±°‰∏ä
instance.interceptors.request.use((config: InternalAxiosRequestConfig) => {

  // üí•ÊØèÊ¨°ÂèëËØ∑Ê±ÇÂâç, Ëá™Âä®Âú®ËøôÈáåÊ∑ªÂä†tokenÂà∞ËØ∑Ê±ÇÂ§¥‰∏ä
  // 2. ÂÖàËé∑Âèñtoken
  const user = AppStorage.get('user') as iLoginUserModel

  // 3. Âà§Êñ≠userÊòØ‰∏çÊòØundefined
  if (user !== undefined) {
    // 4. Ê∑ªÂä†tokenÂà∞ËØ∑Ê±ÇÂ§¥‰∏ä
    // 5. Âà†Èô§ÊâÄÊúâÊé•Âè£‰∏≠‰º†ÂèÇÁöÑtoken, ÊµãËØïÊé•Âè£Ê≠£Â∏∏
    config.headers.Authorization = `Bearer ${user.token}`
  }

  // console.log('ËØ∑Ê±ÇÂâçËß¶Âèë‰∫Ü, ÂèØ‰ª•ÁúãÂà∞ËØ∑Ê±ÇÁöÑÂèÇÊï∞ -----> ', JSON.stringify(config))

  return config;
}, (error: AxiosError) => {
  return Promise.reject(error);
});


// ÈúÄÊ±Ç: Áªü‰∏ÄÂ§ÑÁêÜÂºÇÂ∏∏: ‰∏öÂä°Áä∂ÊÄÅÁ†Å‰∏ç‰∏∫10000ÁöÑÂºÇÂ∏∏
instance.interceptors.response.use(
  (res: AxiosResponse) => {

    // 1. Ê∑ªÂä†ÂìçÂ∫îÊã¶Êà™Âô®

    // 2. Âà§Êñ≠10000‰∏öÂä°Áä∂ÊÄÅÁ†ÅÂºÇÂ∏∏
    if (res.data.code !== 10000) {
      // 3.  ÊèêÁ§∫Áî®Êà∑
      promptAction.showToast({ message: res.data.message })

      //4. ËøîÂõûÂ§±Ë¥•Áä∂ÊÄÅ,  ÈòªÊ≠¢ÂêéÁª≠‰ª£Á†ÅÊâßË°å
      return Promise.reject(res)
    }

    // 5. ÊàêÂäüÊó∂, Ê≠£Â∏∏ËøîÂõûÂìçÂ∫îÊï∞ÊçÆ
    return res;

    //   6. ÁªÑ‰ª∂Ë∞ÉÁî®Êé•Âè£Êó∂, Âà†Èô§ÊéâÂà§Êñ≠10000ÁöÑÈÄªËæë
  },
  (error: AxiosError) => {

    // Â§±Ë¥•Êó∂ÁöÑÂìçÂ∫î
    return Promise.reject(error);
  });