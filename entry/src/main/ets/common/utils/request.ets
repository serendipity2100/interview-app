import axios, { AxiosError, AxiosRequestConfig, AxiosResponse, InternalAxiosRequestConfig } from '@ohos/axios'
import { iLoginUserModel } from '../../models/AccountModel';
import { promptAction, router } from '@kit.ArkUI';

export const instance = axios.create({
  baseURL: 'https://api-harmony-teach.itheima.net/'
})

export interface IRes<T> {
  /** è¯·æ±‚æˆåŠŸ10000æ ‡å¿— */
  code: number;

  /** è¿”å›æ•°æ® */
  data: T;

  /** è¯·æ±‚æˆåŠŸ */
  message: string;

  /** è¯·æ±‚æˆåŠŸæ ‡å¿— */
  success: boolean;
}

export function request<T = null, D = null>(config: AxiosRequestConfig<D>) {

  return instance<null, AxiosResponse<IRes<T>, null>, D>(config)
}


instance.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {

    const user = AppStorage.get('user') as iLoginUserModel
    if (user !== undefined) {
      // ğŸ’¥åˆ é™¤bug
      config.headers.Authorization = `Bearer ${user.token}`
    }

    return config;

  },
  (error: AxiosError) => {
    return Promise.reject(error);
  }
);


instance.interceptors.response.use(
  (res: AxiosResponse) => {
    // httpçŠ¶æ€ç  ä¸€å®šæ˜¯2xx
    if (res.data.code !== 10000) {
      promptAction.showToast({ message: res.data.message })
      return Promise.reject(res)
    }
    return res;

  },
  (error: AxiosError) => {

    if (error.response?.status === 401) {
      promptAction.showToast({ message: 'ç™»å½•è¿‡æœŸ, è¯·é‡æ–°ç™»å½•' })

      setTimeout(() => {
        router.pushUrl({ url: 'pages/LoginPage' })
      }, 500)

      return
    }

    AlertDialog.show({ message: 'æ¥å£è°ƒç”¨å¤±è´¥' + JSON.stringify(error, null, 2), alignment: DialogAlignment.Center })
    return Promise.reject(error);
  }
);

