import axios, { AxiosError, AxiosRequestConfig, AxiosResponse, InternalAxiosRequestConfig } from '@ohos/axios'
import { iLoginUserModel } from '../../models/AccountModel';
import { promptAction } from '@kit.ArkUI';

export const instance = axios.create({
  baseURL: 'https://api-harmony-teach.itheima.net/'
})


export function request<T = null, D = null>(config: AxiosRequestConfig<D>) {
  return instance<null, AxiosResponse<T, null>, D>(config)
}


// æ‹¦æˆªå™¨:
// æœ¬è´¨: é’©å­å‡½æ•° - è‡ªåŠ¨æ‰§è¡Œ
// æ—¶æœº: è¯·æ±‚æ‹¦æˆªå™¨ - è¯·æ±‚å‰æ‰§è¡Œ
// æ—¶æœº: å“åº”æ‹¦æˆªå™¨ - å“åº”æ—¶æ‰§è¡Œ

// 1. æ‹¦æˆªå™¨é…ç½®åœ¨å®ä¾‹å¯¹è±¡ä¸Š
instance.interceptors.request.use((config: InternalAxiosRequestConfig) => {

  // ğŸ’¥æ¯æ¬¡å‘è¯·æ±‚å‰, è‡ªåŠ¨åœ¨è¿™é‡Œæ·»åŠ tokenåˆ°è¯·æ±‚å¤´ä¸Š
  // 2. å…ˆè·å–token
  const user = AppStorage.get('user') as iLoginUserModel

  // 3. åˆ¤æ–­useræ˜¯ä¸æ˜¯undefined
  if (user !== undefined) {
    // 4. æ·»åŠ tokenåˆ°è¯·æ±‚å¤´ä¸Š
    // 5. åˆ é™¤æ‰€æœ‰æ¥å£ä¸­ä¼ å‚çš„token, æµ‹è¯•æ¥å£æ­£å¸¸
    config.headers.Authorization = `Bearer ${user.token}`
  }

  // console.log('è¯·æ±‚å‰è§¦å‘äº†, å¯ä»¥çœ‹åˆ°è¯·æ±‚çš„å‚æ•° -----> ', JSON.stringify(config))

  return config;
}, (error: AxiosError) => {
  return Promise.reject(error);
});


// éœ€æ±‚: ç»Ÿä¸€å¤„ç†å¼‚å¸¸: ä¸šåŠ¡çŠ¶æ€ç ä¸ä¸º10000çš„å¼‚å¸¸
instance.interceptors.response.use(
  (res: AxiosResponse) => {

    if (res.data.code !== 10000) {
      promptAction.showToast({ message: res.data.message })
      return Promise.reject(res)
    }

    return res;

  },
  (error: AxiosError) => {
    // å¤±è´¥æ—¶è‡ªå®šæ‰§è¡Œçš„å›è°ƒ

    // 1. ç»Ÿä¸€æç¤ºæ¥å£é”™è¯¯

    // 2. å»ç»„ä»¶ä¸­æŠŠæ¥å£è°ƒç”¨çš„alertæç¤ºéƒ½åˆ é™¤æ‰
    AlertDialog.show({ message: 'æ¥å£è°ƒç”¨å¤±è´¥' + JSON.stringify(error, null, 2), alignment: DialogAlignment.Center })
    return Promise.reject(error);
  });