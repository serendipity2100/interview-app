import { media } from '@kit.MediaKit';

@CustomDialog
export struct WordSoundDialog {
  controller: CustomDialogController // å¿…é¡»è¦æœ‰çš„
  wordEn: string = '' // è‹±æ–‡å•è¯
  wordZh: string = '' // ä¸­æ–‡è§£é‡Š
  @State isGreen: boolean = false // ç”¨æ¥æŽ§åˆ¶é¢œè‰²åˆ‡æ¢çš„
  timer: number = -1
  streamId: number = -1

  async aboutToAppear() {
    //   1. åˆ›å»ºä¸€ä¸ªæ’­æ”¾å™¨
    const player = await media.createAVPlayer() // åˆ›å»ºæˆåŠŸåŽé»˜è®¤æ˜¯é—²ç½®çŠ¶æ€

    //   2. ç»™æ’­æ”¾å™¨è®¾ç½®MP3çš„èµ„æºè·¯å¾„ urlåœ°å€
    player.url = `http://dict.youdao.com/dictvoice?audio=${this.wordEn}&type=1` // mp3ä¸‹è½½æˆåŠŸåŽ, ä¼šå˜æˆåˆå§‹çŠ¶æ€

    //   3. ðŸ’¥ðŸ’¥ç›‘å¬çŠ¶æ€çš„å˜åŒ–,
    player.on('stateChange', (state) => {


      // 4. è¿›å…¥åˆå§‹çŠ¶æ€åŽ, æ‰å¯ä»¥è°ƒç”¨å‡†å¤‡å‡½æ•°
      if (state === 'initialized') {
        player.prepare() //  prepare()ä¼šè®©æ’­æ”¾å™¨è¿›å…¥ å‡†å¤‡çŠ¶æ€prepared
      }

      // 5. è¿›å…¥å‡†å¤‡çŠ¶æ€åŽ, æ‰å¯ä»¥è°ƒç”¨æ’­æ”¾å‡½æ•°play()
      if (state === 'prepared') {
        player.loop = true
        player.play()
      }

    })

  }

  aboutToDisappear(): void {
    console.log('é”€æ¯äº† -----> ', this.wordZh)
  }

  build() {
    Column({ space: 10 }) {
      Row({ space: 10 }) {
        Text(this.wordEn)
          .fontSize(20)
          .fontColor(Color.White)
          .fontWeight(500)
        Image($r('app.media.icon_public_search'))
          .width(20)
          .aspectRatio(1)
          .fillColor(this.isGreen ? $r('app.color.common_green') : Color.White)
          .onAppear(() => {
            clearInterval(this.timer) // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            this.timer = setInterval(() => { //æ–°å¼€ä¸€ä¸ªå®šæ—¶å™¨
              this.isGreen = !this.isGreen
            }, 500)
          })
          .onDisAppear(() => {
            clearInterval(this.timer) //æ¸…é™¤å®šæ—¶å™¨
          })
          .animation({ duration: 300 })
      }

      Text(this.wordZh)
        .fontColor(Color.White)
    }
    .constraintSize({ minWidth: 175 })
    .padding({ left: 16, right: 16 })
    .height(90)
    .borderRadius(45)
    .backgroundColor('#8f000000')
    .justifyContent(FlexAlign.Center)
  }
}